<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gustafs - Finansiell Planering</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f0e8 0%, #e8dcc8 100%);
            color: #3a3a3a;
            min-height: 100vh;
            transition: background 0.5s ease;
        }

        /* --- KUND-TEMA --- */
        body.customer-mode {
            background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
        }

        body.customer-mode .navbar,
        body.customer-mode .category-header-row,
 
        body.customer-mode .enter-btn,
        body.customer-mode .viz-btn.active,
        body.customer-mode .export-btn {
            background: linear-gradient(135deg, #006064 0%, #00838f 100%);
        }

        body.customer-mode .welcome-page h1,
        body.customer-mode .sheet-header h2,
        body.customer-mode .nav-logo {
            color: #006064;
        }

        body.customer-mode th {
            color: #004d40;
            background: #e0f2f1;
            border-bottom: 2px solid #b2dfdb;
        }
        
        body.customer-mode .subtotal-row {
            background: #e0f2f1;
            border-top: 2px solid #80cbc4;
            border-bottom: 2px solid #80cbc4;
        }

        body.customer-mode .bar-fill {
            background: linear-gradient(90deg, #00838f 0%, #26c6da 100%);
        }

        /* --- Welcome Page --- */
        .welcome-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 40px 20px;
            text-align: center;
            background-image: url('B_bild1.jpg'); 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #f5f0e8; 
            position: relative;
        }

        .welcome-overlay {
            background: rgba(255, 255, 255, 0.90);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(214, 148, 148, 0.1);
            max-width: 700px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .welcome-page.hidden {
            display: none;
        }

        .logo {
            width: 200px;
            height: 80px;

            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;

            border-radius: 20px;
        
            background: url("logo.jpg");

            background-repeat: no-repeat;
            background-position: center;
            background-size: cover;

            backdrop-filter: blur(5px);

            color: transparent;
            font-size: 0;

            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.25));
        }


        .welcome-page h1 {
            font-size: 30px;
            font-weight: 300;
            color: #6b5436;
            margin-bottom: 15px;
            letter-spacing: -1px;
        }

        .welcome-page h3 {
            font-size: 20px;
            color: #555;
            margin-bottom: 20px;
            font-weight: 400;
        }

        .welcome-page p {
            font-size: 16px;
            color: #555;
            margin-bottom:30px;
            line-height: 1.6;
            text-align: center;
        }

        .button-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .enter-btn {
            background: linear-gradient(135deg, #8b6f47 0%, #6b5436 100%);
            color: #f5f0e8;
            border: none;
            padding: 16px 40px;
            font-size: 16px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0, 0.2);
            font-weight: 500;
            letter-spacing: 0.5px;
            min-width: 220px;
        }

        .enter-btn.customer-btn {
            background: linear-gradient(135deg, #00838f 0%, #006064 100%);
        }

        .enter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0,0,0, 0.3);
        }

        /* --- Main App --- */
        .app-container {
            display: none;
            min-height: 100vh;
        }

        .app-container.active {
            display: block;
        }

        /* Navigation */
        .navbar {
            background: linear-gradient(135deg, #8b6f47 0%, #6b5436 100%);
            padding: 0;
            box-shadow: 0 2px 10px rgba(0,0,0, 0.2);
            transition: background 0.5s ease;
        }

        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            padding: 0 30px;
        }

        .nav-logo {
            width: 100px;
            height: 50px;
            margin: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            background: url("logo.jpg");
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover;
            backdrop-filter: blur(5px);
            color: transparent;
            font-size: 0;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.25));
        }
        
        
        .nav-logo:hover {
            opacity: 0.8;
        }
        .nav-tabs {
        display: flex;
        gap: 3px;
        flex-wrap: wrap;
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);

        }.nav-btn {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(245, 240, 232, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-bottom: none;

            padding: 12px 22px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;

            border-top-left-radius: 6px;
            border-top-right-radius: 6px;

            transition: all 0.2s ease;
        }

       
        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #f5f0e8;
        }

        /* Aktiv Excel-flik */
        .nav-btn.active {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            border-color: rgba(255, 255, 255, 0.95);
            position: relative;
            top: 1px; /* lyfter fliken över arket */
        }

        /* Content Area */
        .content-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 30px;
        }

        .sheet {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .sheet.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Sheet Header & Export Button */
        .sheet-header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-text h2 {
            font-size: 32px;
            font-weight: 300;
            color: #6b5436;
            margin-bottom: 10px;
            letter-spacing: -0.5px;
        }

        .header-text p {
            color: #8b7355;
            font-size: 15px;
        }

        .export-btn {
            background: linear-gradient(135deg, #8b6f47 0%, #6b5436 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .export-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* Table Styles */
        .table-wrapper {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            padding: 20px; /* Padding for print looks better */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            background: #f8f5f0;
            color: #6b5436;
            font-weight: 500;
            text-align: right;
            padding: 14px 12px;
            border-bottom: 2px solid #e8dcc8;
            font-size: 13px;
            letter-spacing: 0.3px;
        }

        th:first-child {
            text-align: left;
            padding-left: 20px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f0ebe3;
            text-align: right;
            color: #5a5a5a;
        }

        td:first-child {
            text-align: left;
            font-weight: 500;
            color: inherit;
            padding-left: 20px;
        }

        tr:hover {
            background: #fafaf8;
        }

        .category-header-row {
            background: linear-gradient(135deg, #8b6f47 0%, #6b5436 100%);
            transition: background 0.5s ease;
        }

        .category-header-row td {
            color: #f5f0e8;
            font-weight: 500;
            padding: 14px 20px;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
            border: none;
        }

        .subtotal-row {
            background: #f0ebe3;
            font-weight: 600;
            border-top: 2px solid #d4c9b5;
            border-bottom: 2px solid #d4c9b5;
        }

        .subtotal-row td {
            color: inherit;
            padding: 14px 12px;
        }

        input[type="number"] {
            width: 100%;
            border: 1px solid transparent;
            text-align: right;
            font-family: inherit;
            font-size: inherit;
            background: transparent;
            color: inherit;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        input[type="number"]:hover {
            background: #fafaf8;
            border-color: #e8dcc8;
        }

        input[type="number"]:focus {
            outline: none;
            background: #fff;
            border-color: #8b6f47;
            box-shadow: 0 0 0 3px rgba(139, 111, 71, 0.1);
        }

        .readonly-cell {
            background: rgba(0,0,0,0.02);
            font-weight: 500;
        }

        .negative {
            color: #c85450;
        }

        /* Visualization Styles */
        .viz-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .viz-btn {
            background: white;
            color: #3a3a3a;
            border: 2px solid #ddd;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .viz-btn:hover {
            background: #f8f5f0;
            border-color: #aaa;
        }

        .viz-btn.active {
            background: linear-gradient(135deg, #8b6f47 0%, #6b5436 100%);
            color: #f5f0e8;
            border-color: transparent;
        }

        .viz-container {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        }

        .viz-container.active {
            display: block;
        }

        .viz-container h3 {
            font-size: 20px;
            font-weight: 400;
            color: #6b5436;
            margin-bottom: 25px;
        }

        /* Pie Chart */
        .chart-wrapper {
            max-width: 400px;
            margin: 0 auto 40px;
        }

        #categoryChart {
            max-width: 100%;
            height: auto;
        }

        /* Bar Chart */
        .bar-chart {
            padding-top: 20px;
        }

        .bar-item {
            margin-bottom: 20px;
        }

        .bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            color: #6b5436;
            font-weight: 500;
        }

        .bar-amount {
            color: #8b7355;
        }

        .bar-bg {
            background: #f0ebe3;
            height: 32px;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b6f47 0%, #a0825a 100%);
            transition: width 1s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 12px;
            color: white;
            font-size: 13px;
            font-weight: 600;
        }

        /* Comparison Chart */
        .comparison-chart {
            padding-top: 10px;
        }

        .comparison-item {
            margin-bottom: 30px;
        }

        .comparison-label {
            font-size: 15px;
            color: #6b5436;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .comparison-bars {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .comparison-bar {
            flex: 1;
        }

        .comparison-bar-label {
            font-size: 12px;
            color: #8b7355;
            margin-bottom: 6px;
        }

        .comparison-bar-bg {
            background: #f0ebe3;
            height: 28px;
            border-radius: 6px;
            overflow: hidden;
        }

        .comparison-bar-fill {
            height: 100%;
            display: flex;
            align-items: center;
            padding: 0 10px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            transition: width 1s ease;
        }

        .comparison-planned .comparison-bar-fill {
            background: linear-gradient(90deg, #8b6f47 0%, #a0825a 100%);
        }

        .comparison-actual .comparison-bar-fill {
            background: linear-gradient(90deg, #c85450 0%, #d97773 100%);
        }

        .comparison-diff {
            min-width: 80px;
            text-align: right;
            font-size: 14px;
            font-weight: 600;
        }

        .comparison-diff.positive { color: #4a9d5f; }
        .comparison-diff.negative { color: #c85450; }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-content {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px 20px;
            }
            .nav-logo { margin-right: 0; margin-bottom: 10px; }
            .nav-tabs { width: 100%; overflow-x: auto; }
            .nav-btn { padding: 15px 20px; }
            .content-wrapper { padding: 20px 15px; }
            .welcome-page h1 { font-size: 32px; }
            .table-wrapper { overflow-x: auto; }
            .chart-wrapper { max-width: 100%; }
            .comparison-bars { flex-direction: column; gap: 15px; }
            .comparison-diff { text-align: left; margin-top: 5px; }
            .sheet-header { flex-direction: column; gap: 10px; }
            .export-btn { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="welcome-page" id="welcomePage">
        <div class="welcome-overlay">
            <div class="logo"></div>
            <h1>Om oss</h1>
           <p> Designad för både öga och öra. Väggar och tak med karaktär. Gustafs förenar hög kvalitet, estetik, utmärkta akustiska egenskaper och brandsäkerhet.
            <br><br>Gustafs Scandinavia är välkänt för sina träprodukter och deras exceptionella kvalitet, inte minst när det gäller paneler från Gustafs.<br><br>
        </p>

            
            <div class="button-group">
                <button class="enter-btn customer-btn" onclick="enterApp('customer')">Kom igång som kund</button>
                <button class="enter-btn" onclick="enterApp('admin')">Kom igång som administratör</button>
            </div>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <nav class="navbar">
            <div class="nav-content">
                <div class="nav-logo" onclick="goHome()" title="Gå till startsidan">Gustafs</div>
                <div class="nav-tabs">
                    <button class="nav-btn active" onclick="switchTab('planned')">Planerade utgifter</button>
                    <button class="nav-btn" onclick="switchTab('actual')">Faktiska utgifter</button>
                    <button class="nav-btn" onclick="switchTab('variance')">Avvikelser</button>
                    <button class="nav-btn" onclick="switchTab('analysis')">Analys</button>
                    <button class="nav-btn" onclick="switchTab('visualization')">Visualisering</button>
                </div>
            </div>
        </nav>

        <div class="content-wrapper">
            <div id="planned" class="sheet active">
                <div class="sheet-header">
                    <div class="header-text">
                        <h2>Planerade utgifter</h2>
                        <p>Ange dina budgeterade utgifter för varje månad</p>
                    </div>
                </div>
                <div class="table-wrapper" id="planned-table-container"></div>
            </div>

            <div id="actual" class="sheet">
                <div class="sheet-header">
                    <div class="header-text">
                        <h2>Faktiska utgifter</h2>
                        <p>Registrera dina verkliga utgifter</p>
                    </div>
                </div>
                <div class="table-wrapper" id="actual-table-container"></div>
            </div>

            <div id="variance" class="sheet">
                <div class="sheet-header">
                    <div class="header-text">
                        <h2>Avvikelser</h2>
                        <p>Beräknas automatiskt: Planerat - Faktiskt</p>
                    </div>
                </div>
                <div class="table-wrapper" id="variance-table-container"></div>
            </div>

            <div id="analysis" class="sheet">
                <div class="sheet-header">
                    <div class="header-text">
                        <h2>Analys</h2>
                        <p>Sammanfattningsrapport av dina utgifter</p>
                    </div>
                    <button class="export-btn" onclick="downloadPDF('analysis')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        Ladda ner Analys (PDF)
                    </button>
                </div>
                <div class="table-wrapper" id="analysis-table-container"></div>
            </div>

            <div id="visualization" class="sheet">
                <div class="sheet-header">
                    <div class="header-text">
                        <h2>Visualisering</h2>
                        <p>Grafisk överblick av dina utgifter</p>
                    </div>
                    <button class="export-btn" onclick="downloadPDF('visualization')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        Ladda ner Graf (PDF)
                    </button>
                </div>
                
                <div class="viz-controls">
                    <button class="viz-btn active" onclick="showVisualization('category')">Kategorifördelning</button>
                    <button class="viz-btn" onclick="showVisualization('trend')">Månadstrend</button>
                    <button class="viz-btn" onclick="showVisualization('comparison')">Planerat vs Faktiskt</button>
                </div>

                <div id="categoryViz" class="viz-container active">
                    <h3>Utgiftsfördelning per kategori (Totalt år)</h3>
                    <div class="chart-wrapper">
                        <canvas id="categoryChart"></canvas>
                    </div>
                    <div id="categoryBars" class="bar-chart"></div>
                </div>

                <div id="trendViz" class="viz-container">
                    <h3>Månatlig utgiftstrend</h3>
                    <div class="line-chart" id="lineChart"></div>
                </div>

                <div id="comparisonViz" class="viz-container">
                    <h3>Planerat vs Faktiskt per kategori</h3>
                    <div id="comparisonBars" class="comparison-chart"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const appData = [
            {"category": "Personalkostnader", "items": [{"name": "Löner", "planned": [85000.0, 85000.0, 85000.0, 87500.0, 87500.0, 87500.0, 87500.0, 92400.0, 92400.0, 92400.0, 92400.0, 92400.0], "actual": [85000.0, 85000.0, 85000.0, 88000.0, 88000.0, 88000.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "Förmåner", "planned": [22950.0, 22950.0, 22950.0, 23625.0, 23625.0, 23625.0, 23625.0, 24948.0, 24948.0, 24948.0, 24948.0, 24948.0], "actual": [22950.0, 22950.0, 22950.0, 23760.0, 23760.0, 23760.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}]}, 
            {"category": "Kontorskostnader", "items": [{"name": "Hyra", "planned": [9800.0, 9800.0, 9800.0, 9800.0, 9800.0, 9800.0, 9800.0, 9800.0, 9800.0, 9800.0, 9800.0, 9800.0], "actual": [9800.0, 9800.0, 9800.0, 9800.0, 9800.0, 9800.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "Gas", "planned": [300.0, 400.0, 400.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 400.0, 400.0], "actual": [4.0, 430.0, 385.0, 230.0, 87.0, 88.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "El", "planned": [300.0, 300.0, 300.0, 300.0, 300.0, 300.0, 300.0, 300.0, 300.0, 300.0, 300.0, 300.0], "actual": [288.0, 278.0, 268.0, 299.0, 306.0, 290.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "Vatten", "planned": [40.0, 40.0, 40.0, 40.0, 40.0, 40.0, 40.0, 40.0, 40.0, 40.0, 40.0, 40.0], "actual": [35.0, 33.0, 34.0, 36.0, 34.0, 36.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "Telefon", "planned": [250.0, 250.0, 250.0, 250.0, 250.0, 250.0, 250.0, 250.0, 250.0, 250.0, 250.0, 250.0], "actual": [224.0, 235.0, 265.0, 245.0, 245.0, 220.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "Internet", "planned": [180.0, 180.0, 180.0, 180.0, 180.0, 180.0, 180.0, 180.0, 180.0, 180.0, 180.0, 180.0], "actual": [180.0, 180.0, 180.0, 180.0, 180.0, 180.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "Kontorsmaterial", "planned": [200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0], "actual": [256.0, 142.0, 160.0, 221.0, 256.0, 240.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "Säkerhet", "planned": [600.0, 600.0, 600.0, 600.0, 600.0, 600.0, 600.0, 600.0, 600.0, 600.0, 600.0, 600.0], "actual": [600.0, 600.0, 600.0, 600.0, 600.0, 600.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}]}, 
            {"category": "Marknadsföring", "items": [{"name": "Webbhotell", "planned": [500.0, 500.0, 500.0, 500.0, 500.0, 500.0, 500.0, 500.0, 500.0, 500.0, 500.0, 500.0], "actual": [500.0, 500.0, 500.0, 500.0, 500.0, 500.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "Webbuppdateringar", "planned": [200.0, 200.0, 200.0, 200.0, 200.0, 1000.0, 200.0, 200.0, 200.0, 200.0, 200.0, 1000.0], "actual": [200.0, 200.0, 200.0, 200.0, 200.0, 1500.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "Materialframställning", "planned": [5000.0, 0.0, 0.0, 5000.0, 0.0, 0.0, 5000.0, 0.0, 0.0, 5000.0, 0.0, 0.0], "actual": [4800.0, 0.0, 0.0, 5500.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "Trycksaker", "planned": [200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0], "actual": [100.0, 500.0, 100.0, 100.0, 600.0, 180.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "Evenemang", "planned": [2000.0, 2000.0, 2000.0, 5000.0, 2000.0, 2000.0, 2000.0, 5000.0, 2000.0, 2000.0, 2000.0, 5000.0], "actual": [1800.0, 2200.0, 2200.0, 4700.0, 1500.0, 2300.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "Övrigt", "planned": [200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0], "actual": [145.0, 156.0, 123.0, 223.0, 187.0, 245.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}]}, 
            {"category": "Utbildning/Resor", "items": [{"name": "Utbildning", "planned": [2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0], "actual": [1600.0, 2400.0, 1400.0, 1600.0, 1200.0, 2800.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "Resekostnader", "planned": [2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0], "actual": [1200.0, 2200.0, 1400.0, 1200.0, 800.0, 3500.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}]}
        ];

        const months = ["Jan", "Feb", "Mar", "Apr", "Maj", "Jun", "Jul", "Aug", "Sep", "Okt", "Nov", "Dec"];
        const formatter = new Intl.NumberFormat('sv-SE', {
            style: 'decimal',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });

        let currentRole = 'admin';

        function enterApp(role) {
            currentRole = role;
            
            if (role === 'customer') {
                document.body.classList.add('customer-mode');
            } else {
                document.body.classList.remove('customer-mode');
            }

            document.getElementById('welcomePage').classList.add('hidden');
            document.getElementById('appContainer').classList.add('active');
            renderInputTable('planned');
            
            setTimeout(renderVisualizations, 100);
        }

        // --- NY FUNKTION: Gå hem till startsidan ---
        function goHome() {
            document.getElementById('appContainer').classList.remove('active');
            document.getElementById('welcomePage').classList.remove('hidden');
        }

        // --- NY FUNKTION: Ladda ner PDF ---
        function downloadPDF(type) {
            let element;
            let filename;

            if (type === 'analysis') {
                // Hämta hela tabellen för analys
                element = document.getElementById('analysis-table-container');
                filename = 'Gustafs_Analys.pdf';
            } else if (type === 'visualization') {
                // Hitta vilken visualisering som är aktiv just nu
                if(document.getElementById('categoryViz').classList.contains('active')) {
                    element = document.getElementById('categoryViz');
                    filename = 'Gustafs_Kategorier.pdf';
                } else if (document.getElementById('trendViz').classList.contains('active')) {
                    element = document.getElementById('trendViz');
                    filename = 'Gustafs_Trender.pdf';
                } else if (document.getElementById('comparisonViz').classList.contains('active')) {
                    element = document.getElementById('comparisonViz');
                    filename = 'Gustafs_Jamforelse.pdf';
                }
            }

            if(element) {
                // Konfigurera PDF-inställningar
                const opt = {
                    margin:       10,
                    filename:     filename,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2 },
                    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                // Generera PDF
                html2pdf().set(opt).from(element).save();
            }
        }

        function switchTab(tabId) {
            document.querySelectorAll('.sheet').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            const buttons = document.querySelectorAll('.nav-btn');
            if (tabId === 'planned') { buttons[0].classList.add('active'); renderInputTable('planned'); }
            if (tabId === 'actual') { buttons[1].classList.add('active'); renderInputTable('actual'); }
            if (tabId === 'variance') { buttons[2].classList.add('active'); renderVarianceTable(); }
            if (tabId === 'analysis') { buttons[3].classList.add('active'); renderAnalysisTable(); }
            if (tabId === 'visualization') { buttons[4].classList.add('active'); renderVisualizations(); }
        }

        function renderInputTable(type) {
            const container = document.getElementById(type + '-table-container');
            let html = '<table><thead><tr><th>Utgiftspost</th>';
            
            months.forEach(m => html += `<th>${m}</th>`);
            html += '<th>ÅR</th></tr></thead><tbody>';

            appData.forEach(cat => {
                html += `<tr class="category-header-row"><td colspan="14">${cat.category}</td></tr>`;
                
                let catMonthlyTotals = new Array(12).fill(0);

                cat.items.forEach((item, itemIdx) => {
                    html += `<tr><td>${item.name}</td>`;
                    let itemTotal = 0;
                    item[type].forEach((val, monthIdx) => {
                        html += `<td><input type="number" 
                                     value="${val}" 
                                     onchange="updateData('${cat.category}', ${itemIdx}, '${type}', ${monthIdx}, this.value)">
                                 </td>`;
                        itemTotal += val;
                        catMonthlyTotals[monthIdx] += val;
                    });
                    html += `<td class="readonly-cell"><strong>${formatter.format(itemTotal)}</strong></td></tr>`;
                });

                html += `<tr class="subtotal-row"><td>Delsumma</td>`;
                catMonthlyTotals.forEach(val => html += `<td>${formatter.format(val)}</td>`);
                const catTotal = catMonthlyTotals.reduce((a, b) => a + b, 0);
                html += `<td>${formatter.format(catTotal)}</td></tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function updateData(categoryName, itemIdx, type, monthIdx, newValue) {
            const cat = appData.find(c => c.category === categoryName);
            const item = cat.items[itemIdx];
            item[type][monthIdx] = parseFloat(newValue) || 0;
            renderInputTable(type);
        }

        function renderVarianceTable() {
            const container = document.getElementById('variance-table-container');
            let html = '<table><thead><tr><th>Utgiftspost</th>';
            months.forEach(m => html += `<th>${m}</th>`);
            html += '<th>ÅR</th></tr></thead><tbody>';

            appData.forEach(cat => {
                html += `<tr class="category-header-row"><td colspan="14">${cat.category}</td></tr>`;
                
                let catMonthlyTotals = new Array(12).fill(0);

                cat.items.forEach(item => {
                    html += `<tr><td>${item.name}</td>`;
                    let itemTotal = 0;
                    for (let i = 0; i < 12; i++) {
                        const variance = item.planned[i] - item.actual[i];
                        const cls = variance < 0 ? 'negative' : '';
                        html += `<td class="readonly-cell ${cls}">${formatter.format(variance)}</td>`;
                        itemTotal += variance;
                        catMonthlyTotals[i] += variance;
                    }
                    const rowCls = itemTotal < 0 ? 'negative' : '';
                    html += `<td class="readonly-cell ${rowCls}"><strong>${formatter.format(itemTotal)}</strong></td></tr>`;
                });

                html += `<tr class="subtotal-row"><td>Delsumma</td>`;
                catMonthlyTotals.forEach(val => {
                    const cls = val < 0 ? 'negative' : '';
                    html += `<td class="${cls}">${formatter.format(val)}</td>`;
                });
                const catTotal = catMonthlyTotals.reduce((a, b) => a + b, 0);
                const totalCls = catTotal < 0 ? 'negative' : '';
                html += `<td class="${totalCls}">${formatter.format(catTotal)}</td></tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderAnalysisTable() {
            const container = document.getElementById('analysis-table-container');
            let html = '<table><thead><tr><th>Utgiftskategori</th><th>Planerat</th><th>Faktiskt</th><th>Avvikelse</th><th>Avvikelse %</th></tr></thead><tbody>';
            
            let totalPlanned = 0;
            let totalActual = 0;

            appData.forEach(cat => {
                let catPlanned = 0;
                let catActual = 0;
                
                cat.items.forEach(item => {
                    catPlanned += item.planned.reduce((a, b) => a + b, 0);
                    catActual += item.actual.reduce((a, b) => a + b, 0);
                });

                const variance = catPlanned - catActual;
                const percent = catPlanned !== 0 ? (variance / catPlanned) * 100 : 0;
                const cls = variance < 0 ? 'negative' : '';

                html += `<tr>
                    <td>${cat.category}</td>
                    <td>${formatter.format(catPlanned)}</td>
                    <td>${formatter.format(catActual)}</td>
                    <td class="${cls}">${formatter.format(variance)}</td>
                    <td class="${cls}">${percent.toFixed(1)}%</td>
                </tr>`;

                totalPlanned += catPlanned;
                totalActual += catActual;
            });

            const totalVariance = totalPlanned - totalActual;
            const totalPercent = totalPlanned !== 0 ? (totalVariance / totalPlanned) * 100 : 0;
            const totalCls = totalVariance < 0 ? 'negative' : '';

            html += `<tr class="subtotal-row">
                <td>TOTALT</td>
                <td>${formatter.format(totalPlanned)}</td>
                <td>${formatter.format(totalActual)}</td>
                <td class="${totalCls}">${formatter.format(totalVariance)}</td>
                <td class="${totalCls}">${totalPercent.toFixed(1)}%</td>
            </tr>`;
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function showVisualization(type) {
            document.querySelectorAll('.viz-container').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.viz-btn').forEach(b => b.classList.remove('active'));
            
            if (type === 'category') {
                document.getElementById('categoryViz').classList.add('active');
                document.querySelectorAll('.viz-btn')[0].classList.add('active');
            } else if (type === 'trend') {
                document.getElementById('trendViz').classList.add('active');
                document.querySelectorAll('.viz-btn')[1].classList.add('active');
            } else if (type === 'comparison') {
                document.getElementById('comparisonViz').classList.add('active');
                document.querySelectorAll('.viz-btn')[2].classList.add('active');
            }
        }

        function renderVisualizations() {
            renderCategoryChart();
            renderTrendChart();
            renderComparisonChart();
        }

        function renderCategoryChart() {
            const categoryData = appData.map(cat => {
                let total = 0;
                cat.items.forEach(item => {
                    total += item.actual.reduce((a, b) => a + b, 0);
                });
                return { name: cat.category, value: total };
            });

            const total = categoryData.reduce((a, b) => a + b.value, 0);

            // Draw Pie Chart
            const canvas = document.getElementById('categoryChart');
            const ctx = canvas.getContext('2d');
            const size = 300;
            canvas.width = size;
            canvas.height = size;
            
            const centerX = size / 2;
            const centerY = size / 2;
            const radius = size / 2 - 20;
            
            const isCustomer = document.body.classList.contains('customer-mode');
            const colors = isCustomer 
                ? ['#00838f', '#0097a7', '#00acc1', '#26c6da']
                : ['#8b6f47', '#a0825a', '#b5956d', '#6b5436'];

            let currentAngle = -Math.PI / 2;

            categoryData.forEach((cat, i) => {
                const sliceAngle = (cat.value / total) * 2 * Math.PI;
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.lineTo(centerX, centerY);
                ctx.fillStyle = colors[i % colors.length];
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 3;
                ctx.stroke();
                currentAngle += sliceAngle;
            });

            // Render Bar Chart
            const barsContainer = document.getElementById('categoryBars');
            let html = '';
            categoryData.forEach((cat, i) => {
                const percentage = ((cat.value / total) * 100).toFixed(1);
                let gradientStyle = `background: linear-gradient(90deg, ${colors[i % colors.length]} 0%, ${colors[i % colors.length]}dd 100%);`;

                html += `
                    <div class="bar-item">
                        <div class="bar-label">
                            <span>${cat.name}</span>
                            <span class="bar-amount">${formatter.format(cat.value)} kr</span>
                        </div>
                        <div class="bar-bg">
                            <div class="bar-fill" style="width: ${percentage}%; ${gradientStyle}">
                                ${percentage}%
                            </div>
                        </div>
                    </div>
                `;
            });
            barsContainer.innerHTML = html;
        }

        function renderTrendChart() {
            const container = document.getElementById('lineChart');
            const isCustomer = document.body.classList.contains('customer-mode');

            const monthlyPlanned = new Array(12).fill(0);
            const monthlyActual = new Array(12).fill(0);

            appData.forEach(cat => {
                cat.items.forEach(item => {
                    for (let i = 0; i < 12; i++) {
                        monthlyPlanned[i] += item.planned[i];
                        monthlyActual[i] += item.actual[i];
                    }
                });
            });

            const maxValue = Math.max(...monthlyPlanned, ...monthlyActual);
            const chartHeight = 350;
            const chartWidth = 900;
            const padding = 50;
            const plotHeight = chartHeight - padding * 2;
            const plotWidth = chartWidth - padding * 2;

            let svg = `<svg class="line-svg" viewBox="0 0 ${chartWidth} ${chartHeight}">`;

            for (let i = 0; i <= 5; i++) {
                const y = padding + (plotHeight / 5) * i;
                svg += `<line x1="${padding}" y1="${y}" x2="${chartWidth - padding}" y2="${y}" class="line-grid"/>`;
                const value = Math.round(maxValue * (5 - i) / 5);
                svg += `<text x="${padding - 10}" y="${y + 5}" text-anchor="end" class="line-label">${formatter.format(value)}</text>`;
            }

            months.forEach((month, i) => {
                const x = padding + (plotWidth / 11) * i;
                svg += `<text x="${x}" y="${chartHeight - padding + 25}" text-anchor="middle" class="line-label">${month}</text>`;
            });

            const colorPlanned = isCustomer ? '#006064' : '#8b6f47';
            const colorActual = '#c85450';

            function createPath(data, className, color) {
                let path = '';
                data.forEach((value, i) => {
                    const x = padding + (plotWidth / 11) * i;
                    const y = padding + plotHeight - (value / maxValue) * plotHeight;
                    if (i === 0) path += `M ${x} ${y}`;
                    else path += ` L ${x} ${y}`;
                });
                svg += `<path d="${path}" class="line-path" style="stroke: ${color}; fill: none; stroke-width: 3;"/>`;
                data.forEach((value, i) => {
                    const x = padding + (plotWidth / 11) * i;
                    const y = padding + plotHeight - (value / maxValue) * plotHeight;
                    svg += `<circle cx="${x}" cy="${y}" class="line-point" r="5" style="fill: white; stroke: ${color}; stroke-width: 2;"/>`;
                });
            }

            createPath(monthlyPlanned, 'line-planned', colorPlanned);
            createPath(monthlyActual, 'line-actual', colorActual);

            svg += '</svg>';
            svg += `
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: ${colorPlanned};"></div>
                        <span>Planerat</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: ${colorActual};"></div>
                        <span>Faktiskt</span>
                    </div>
                </div>
            `;
            container.innerHTML = svg;
        }

        function renderComparisonChart() {
            const container = document.getElementById('comparisonBars');
            const isCustomer = document.body.classList.contains('customer-mode');
            
            const comparisonData = appData.map(cat => {
                let planned = 0;
                let actual = 0;
                cat.items.forEach(item => {
                    planned += item.planned.reduce((a, b) => a + b, 0);
                    actual += item.actual.reduce((a, b) => a + b, 0);
                });
                return { name: cat.category, planned, actual };
            });

            const maxValue = Math.max(...comparisonData.map(d => Math.max(d.planned, d.actual)));
            let html = '';

            const colorPlannedStart = isCustomer ? '#00838f' : '#8b6f47';
            const colorPlannedEnd = isCustomer ? '#26c6da' : '#a0825a';

            comparisonData.forEach(cat => {
                const diff = cat.planned - cat.actual;
                const diffClass = diff >= 0 ? 'positive' : 'negative';
                const plannedPercent = (cat.planned / maxValue) * 100;
                const actualPercent = (cat.actual / maxValue) * 100;

                html += `
                    <div class="comparison-item">
                        <div class="comparison-label">${cat.name}</div>
                        <div class="comparison-bars">
                            <div class="comparison-bar comparison-planned">
                                <div class="comparison-bar-label">Planerat</div>
                                <div class="comparison-bar-bg">
                                    <div class="comparison-bar-fill" style="width: ${plannedPercent}%; background: linear-gradient(90deg, ${colorPlannedStart} 0%, ${colorPlannedEnd} 100%);">
                                        ${formatter.format(cat.planned)} kr
                                    </div>
                                </div>
                            </div>
                            <div class="comparison-bar comparison-actual">
                                <div class="comparison-bar-label">Faktiskt</div>
                                <div class="comparison-bar-bg">
                                    <div class="comparison-bar-fill" style="width: ${actualPercent}%;">
                                        ${formatter.format(cat.actual)} kr
                                    </div>
                                </div>
                            </div>
                            <div class="comparison-diff ${diffClass}">
                                ${diff >= 0 ? '+' : ''}${formatter.format(diff)} kr
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
    </script>
</body>
</html>