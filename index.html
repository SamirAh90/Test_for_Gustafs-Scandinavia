<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gustafs - Finansiell Planering</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- ORIGINAL STYLES (BEHÅLLNA) --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f0e8 0%, #e8dcc8 100%);
            color: #3a3a3a;
            min-height: 100vh;
            transition: background 0.5s ease;
        }

        /* --- LOGIC STYLES --- */
        #drag-handle {
            position: absolute;
            width: 7px;
            height: 7px;
            background-color: #6b5436;
            border: 1px solid #f5f0e8;
            cursor: crosshair;
            display: none;
            z-index: 9999;
            pointer-events: auto;
        }

        .drag-highlight {
            background-color: rgba(139, 111, 71, 0.2) !important;
            outline: 2px dashed #8b6f47;
            z-index: 10;
            position: relative;
        }

        /* --- BUTTON STYLES --- */
        .add-btn {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.7;
            transition: opacity 0.2s;
            margin-left: 10px;
            display: inline-block;
            color: inherit;
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            border: none;
        }
        .add-btn:hover {
            opacity: 1;
            background: rgba(255,255,255,0.4);
        }

        .add-col-btn {
            background: #e8dcc8;
            color: #6b5436;
            border: none;
            cursor: pointer;
            font-weight: bold;
            padding: 5px 10px;
            margin-left: 5px;
            border-radius: 4px;
        }
        .add-col-btn:hover { background: #d4c9b5; }

        .del-col-btn {
            background: #c85450;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            padding: 5px 10px;
            margin-left: 5px;
            border-radius: 4px;
            font-size: 12px;
        }
        .del-col-btn:hover { background: #a63f3b; }

        .del-row-btn {
            background: transparent;
            color: #c85450;
            border: none;
            cursor: pointer;
            font-size: 11px;
            margin-left: 8px;
            opacity: 0.6;
        }
        .del-row-btn:hover { 
            opacity: 1; 
            text-decoration: underline;
            font-weight: bold;
        }

        .add-category-container {
            margin-top: 20px;
            text-align: center;
        }
        .add-cat-main-btn {
            background: transparent;
            border: 2px dashed #bbb;
            color: #666;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            transition: all 0.2s;
        }
        .add-cat-main-btn:hover {
            border-color: #8b6f47;
            color: #8b6f47;
            background: rgba(255,255,255,0.5);
        }


        /* --- KUND-TEMA --- */
        body.customer-mode {
            background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
        }
        
        body.customer-mode #drag-handle { background-color: #006064; }
        body.customer-mode .drag-highlight {
            background-color: rgba(0, 96, 100, 0.2) !important;
            outline: 2px dashed #006064;
        }

        body.customer-mode .navbar,
        body.customer-mode .category-header-row,
        body.customer-mode .enter-btn,
        body.customer-mode .export-btn {
            background: linear-gradient(135deg, #006064 0%, #00838f 100%);
        }

        body.customer-mode .welcome-page h1,
        body.customer-mode .sheet-header h2,
        body.customer-mode .nav-logo { color: #006064; }

        body.customer-mode th {
            color: #004d40;
            background: #e0f2f1;
            border-bottom: 2px solid #b2dfdb;
        }
        
        body.customer-mode .subtotal-row {
            background: #e0f2f1;
            border-top: 2px solid #80cbc4;
            border-bottom: 2px solid #80cbc4;
        }
        
        body.customer-mode .add-cat-main-btn:hover {
            border-color: #006064;
            color: #006064;
        }

        /* --- Welcome Page --- */
        .welcome-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 40px 20px;
            text-align: center;
            background-image: url('B_bild1.jpg'); 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #f5f0e8; 
            position: relative;
        }

        .welcome-overlay {
            background: rgba(255, 255, 255, 0.90);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            max-width: 700px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .welcome-page.hidden { display: none; }

        .logo {
            width: 200px;
            height: 80px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 20px;
            background: url("logo.jpg");
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover;
            backdrop-filter: blur(5px);
            color: transparent;
            font-size: 0;
        }

        .welcome-page h1 {
            font-size: 30px;
            font-weight: 300;
            color: #6b5436;
            margin-bottom: 15px;
            letter-spacing: -1px;
        }

        .welcome-page p {
            font-size: 16px;
            color: #555;
            margin-bottom:30px;
            line-height: 1.6;
            text-align: center;
        }

        .button-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .enter-btn {
            background: linear-gradient(135deg, #8b6f47 0%, #6b5436 100%);
            color: #f5f0e8;
            border: none;
            padding: 16px 40px;
            font-size: 16px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0, 0.2);
            font-weight: 500;
            letter-spacing: 0.5px;
            min-width: 220px;
        }

        .enter-btn.customer-btn {
            background: linear-gradient(135deg, #00838f 0%, #006064 100%);
        }

        .enter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0,0,0, 0.3);
        }

        /* --- Main App --- */
        .app-container { display: none; min-height: 100vh; }
        .app-container.active { display: block; }

        .navbar {
            background: linear-gradient(135deg, #8b6f47 0%, #6b5436 100%);
            padding: 0;
            box-shadow: 0 2px 10px rgba(0,0,0, 0.2);
            transition: background 0.5s ease;
        }

        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            padding: 0 30px;
        }

        .nav-logo {
            width: 100px;
            height: 50px;
            margin: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            background: url("logo.jpg");
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover;
            cursor: pointer;
        }
        
        .nav-logo:hover { opacity: 0.8; }

        .nav-tabs {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .nav-btn {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(245, 240, 232, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-bottom: none;
            padding: 12px 22px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
            transition: all 0.2s ease;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #f5f0e8;
        }

        .nav-btn.active {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            border-color: rgba(255, 255, 255, 0.95);
            position: relative;
            top: 1px;
        }

        .content-wrapper {
            max-width: 1600px;
            margin: 0 auto;
            padding: 40px 30px;
        }

        .sheet { display: none; animation: fadeIn 0.4s ease; }
        .sheet.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .sheet-header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-text h2 {
            font-size: 32px;
            font-weight: 300;
            color: #6b5436;
            margin-bottom: 10px;
            letter-spacing: -0.5px;
        }

        .header-text p { color: #8b7355; font-size: 15px; }

        .export-btn {
            background: linear-gradient(135deg, #8b6f47 0%, #6b5436 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .export-btn:hover { opacity: 0.9; transform: translateY(-1px); }

        .table-wrapper {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            padding: 20px;
            overflow-x: auto;
        }

        table { width: 100%; border-collapse: collapse; font-size: 14px; }

        th {
            background: #f8f5f0;
            color: #6b5436;
            font-weight: 500;
            text-align: right;
            padding: 14px 12px;
            border-bottom: 1px solid #e8dcc8;
            font-size: 14px;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }
        th:first-child { text-align: left; padding-left: 20px; min-width: 250px; }

        td {
            padding-top:10px;
            padding-bottom:10px;
             border-bottom: 1px solid #90897e;
            text-align: right;
            color: #5a5a5a;
        }
        td:first-child { text-align: left; font-weight: 500; color: inherit; padding-left: 20px; }
        tr:hover { background: #fafaf8; }

        .category-header-row {
            background: linear-gradient(135deg, #8b6f47 0%, #6b5436 100%);
            transition: background 0.5s ease;
        }
        .category-header-row td {
            color: #f5f0e8;
            font-weight: 500;
            padding: 16px 20px;
            text-transform: uppercase;
            font-size: 13px;
            letter-spacing: 1px;
            border: none;
        }

        .subtotal-row {
            background: #f0ebe3;
            font-weight: 600;
            border-top: 2px solid #d4c9b5;
            border-bottom: 2px solid #d4c9b5;
        }
        .subtotal-row td { color: inherit; padding: 18px 16px; }

        input[type="number"] {
            width: 100%;
            border: 1px solid transparent;
            text-align: right;
            font-family: inherit;
            font-size: 14px;
            background: transparent;
            color: inherit;
            padding: 8px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        input[type="number"]:hover { background: #fafaf8; border-color: #e8dcc8; }
        input[type="number"]:focus { outline: none; background: #fff; border-color: #8b6f47; box-shadow: 0 0 0 3px rgba(139, 111, 71, 0.1); }
        .readonly-cell { background: rgba(0,0,0,0.02); font-weight: 500; }
        .negative { color: #c85450; }

        /* --- DASHBOARD LAYOUT STYLES --- */
        .viz-dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding-bottom: 20px;
        }

        .viz-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .viz-card.full-width {
            grid-column: 1 / -1;
        }

        .viz-card h3 {
            font-size: 18px;
            font-weight: 500;
            color: #6b5436;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        /* Chart Containers */
        .chart-box {
            position: relative;
            height: 350px;
            width: 100%;
        }
        
        .pie-chart-box {
            position: relative;
            height: 300px;
            width: 100%;
            display: flex;
            justify-content: center;
        }

        @media (max-width: 900px) {
            .viz-dashboard { grid-template-columns: 1fr; }
            .nav-content { flex-direction: column; align-items: flex-start; padding: 15px 20px; }
            .nav-logo { margin-right: 0; margin-bottom: 10px; }
            .nav-tabs { width: 100%; overflow-x: auto; }
            .nav-btn { padding: 15px 20px; }
            .chart-box, .pie-chart-box { height: 300px; }
        }
    </style>
</head>
<body>
    <div id="drag-handle"></div>

    <div class="welcome-page" id="welcomePage">
        <div class="welcome-overlay">
            <div class="logo"></div>
            <h1>Om oss</h1>
           <p> Designad för både öga och öra. Väggar och tak med karaktär. Gustafs förenar hög kvalitet, estetik, utmärkta akustiska egenskaper och brandsäkerhet.
            <br><br>Gustafs Scandinavia är välkänt för sina träprodukter och deras exceptionella kvalitet, inte minst när det gäller paneler från Gustafs.<br><br>
        </p>

            <div class="button-group">
                <button class="enter-btn customer-btn" onclick="enterApp('customer')">Kom igång som kund</button>
                <button class="enter-btn" onclick="enterApp('admin')">Kom igång som administratör</button>
            </div>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <nav class="navbar">
            <div class="nav-content">
                <div class="nav-logo" onclick="goHome()" title="Gå till startsidan"></div>
                <div class="nav-tabs">
                    <button class="nav-btn active" onclick="switchTab('planned')">Planerade utgifter</button>
                    <button class="nav-btn" onclick="switchTab('actual')">Faktiska utgifter</button>
                    <button class="nav-btn" onclick="switchTab('variance')">Avvikelser</button>
                    <button class="nav-btn" onclick="switchTab('analysis')">Analys</button>
                    <button class="nav-btn" onclick="switchTab('visualization')">Visualisering</button>
                </div>
            </div>
        </nav>

        <div class="content-wrapper">
            <div id="planned" class="sheet active">
                <div class="sheet-header">
                    <div class="header-text">
                        <h2>Planerade utgifter</h2>
                        <p>Ange dina budgeterade utgifter. Dra i cellen för att kopiera. Klicka på [+] för att lägga till rader/kolumner.</p>
                    </div>
                </div>
                <div class="table-wrapper" id="planned-table-container"></div>
            </div>

            <div id="actual" class="sheet">
                <div class="sheet-header">
                    <div class="header-text">
                        <h2>Faktiska utgifter</h2>
                        <p>Registrera dina verkliga utgifter</p>
                    </div>
                </div>
                <div class="table-wrapper" id="actual-table-container"></div>
            </div>

            <div id="variance" class="sheet">
                <div class="sheet-header">
                    <div class="header-text">
                        <h2>Avvikelser</h2>
                        <p>Beräknas automatiskt: Planerat - Faktiskt</p>
                    </div>
                </div>
                <div class="table-wrapper" id="variance-table-container"></div>
            </div>

            <div id="analysis" class="sheet">
                <div class="sheet-header">
                    <div class="header-text">
                        <h2>Analys</h2>
                        <p>Sammanfattningsrapport av dina utgifter</p>
                    </div>
                    <button class="export-btn" onclick="downloadPDF('analysis')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        Ladda ner Analys (PDF)
                    </button>
                </div>
                <div class="table-wrapper" id="analysis-table-container"></div>
            </div>

            <div id="visualization" class="sheet">
                <div class="sheet-header">
                    <div class="header-text">
                        <h2>Visualisering</h2>
                        <p>Grafisk överblick av alla dina utgifter.</p>
                    </div>
                    <button class="export-btn" onclick="downloadPDF('visualization')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        Ladda ner Dashboard (PDF)
                    </button>
                </div>

                <div id="viz-print-area" class="viz-dashboard">
                    
                    <div class="viz-card">
                        <h3>Utgiftsfördelning (Faktiskt)</h3>
                        <div class="pie-chart-box">
                            <canvas id="categoryChartCanvas"></canvas>
                        </div>
                    </div>

                    <div class="viz-card">
                        <h3>Planerat vs Faktiskt per Kategori</h3>
                        <div class="chart-box">
                            <canvas id="comparisonChartCanvas"></canvas>
                        </div>
                    </div>

                    <div class="viz-card full-width">
                        <h3>Utgiftstrend över året</h3>
                        <div class="chart-box">
                            <canvas id="trendChartCanvas"></canvas>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        const appData = [
            {"category": "Personalkostnader", "items": [{"name": "Löner", "planned": [85000.0, 85000.0, 85000.0, 87500.0, 87500.0, 87500.0, 87500.0, 92400.0, 92400.0, 92400.0, 92400.0, 92400.0], "actual": [85000.0, 85000.0, 85000.0, 88000.0, 88000.0, 88000.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "Förmåner", "planned": [22950.0, 22950.0, 22950.0, 23625.0, 23625.0, 23625.0, 23625.0, 24948.0, 24948.0, 24948.0, 24948.0, 24948.0], "actual": [22950.0, 22950.0, 22950.0, 23760.0, 23760.0, 23760.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}]}, 
            {"category": "Kontorskostnader", "items": [{"name": "Hyra", "planned": [9800.0, 9800.0, 9800.0, 9800.0, 9800.0, 9800.0, 9800.0, 9800.0, 9800.0, 9800.0, 9800.0, 9800.0], "actual": [9800.0, 9800.0, 9800.0, 9800.0, 9800.0, 9800.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "Gas", "planned": [300.0, 400.0, 400.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 100.0, 400.0, 400.0], "actual": [4.0, 430.0, 385.0, 230.0, 87.0, 88.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "El", "planned": [300.0, 300.0, 300.0, 300.0, 300.0, 300.0, 300.0, 300.0, 300.0, 300.0, 300.0, 300.0], "actual": [288.0, 278.0, 268.0, 299.0, 306.0, 290.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "Vatten", "planned": [40.0, 40.0, 40.0, 40.0, 40.0, 40.0, 40.0, 40.0, 40.0, 40.0, 40.0, 40.0], "actual": [35.0, 33.0, 34.0, 36.0, 34.0, 36.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "Telefon", "planned": [250.0, 250.0, 250.0, 250.0, 250.0, 250.0, 250.0, 250.0, 250.0, 250.0, 250.0, 250.0], "actual": [224.0, 235.0, 265.0, 245.0, 245.0, 220.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "Internet", "planned": [180.0, 180.0, 180.0, 180.0, 180.0, 180.0, 180.0, 180.0, 180.0, 180.0, 180.0, 180.0], "actual": [180.0, 180.0, 180.0, 180.0, 180.0, 180.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "Kontorsmaterial", "planned": [200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0], "actual": [256.0, 142.0, 160.0, 221.0, 256.0, 240.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "Säkerhet", "planned": [600.0, 600.0, 600.0, 600.0, 600.0, 600.0, 600.0, 600.0, 600.0, 600.0, 600.0, 600.0], "actual": [600.0, 600.0, 600.0, 600.0, 600.0, 600.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}]}, 
            {"category": "Marknadsföring", "items": [{"name": "Webbhotell", "planned": [500.0, 500.0, 500.0, 500.0, 500.0, 500.0, 500.0, 500.0, 500.0, 500.0, 500.0, 500.0], "actual": [500.0, 500.0, 500.0, 500.0, 500.0, 500.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "Webbuppdateringar", "planned": [200.0, 200.0, 200.0, 200.0, 200.0, 1000.0, 200.0, 200.0, 200.0, 200.0, 200.0, 1000.0], "actual": [200.0, 200.0, 200.0, 200.0, 200.0, 1500.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "Materialframställning", "planned": [5000.0, 0.0, 0.0, 5000.0, 0.0, 0.0, 5000.0, 0.0, 0.0, 5000.0, 0.0, 0.0], "actual": [4800.0, 0.0, 0.0, 5500.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "Trycksaker", "planned": [200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0], "actual": [100.0, 500.0, 100.0, 100.0, 600.0, 180.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "Evenemang", "planned": [2000.0, 2000.0, 2000.0, 5000.0, 2000.0, 2000.0, 2000.0, 5000.0, 2000.0, 2000.0, 2000.0, 5000.0], "actual": [1800.0, 2200.0, 2200.0, 4700.0, 1500.0, 2300.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "Övrigt", "planned": [200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0, 200.0], "actual": [145.0, 156.0, 123.0, 223.0, 187.0, 245.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}]}, 
            {"category": "Utbildning/Resor", "items": [{"name": "Utbildning", "planned": [2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0], "actual": [1600.0, 2400.0, 1400.0, 1600.0, 1200.0, 2800.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}, {"name": "Resekostnader", "planned": [2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0, 2000.0], "actual": [1200.0, 2200.0, 1400.0, 1200.0, 800.0, 3500.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}]}
        ];

        const months = ["Jan", "Feb", "Mar", "Apr", "Maj", "Jun", "Jul", "Aug", "Sep", "Okt", "Nov", "Dec"];
        const formatter = new Intl.NumberFormat('sv-SE', {
            style: 'decimal',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });

        let chartInstances = {
            category: null,
            trend: null,
            comparison: null
        };

        let currentRole = 'admin';

        function enterApp(role) {
            currentRole = role;
            
            if (role === 'customer') {
                document.body.classList.add('customer-mode');
            } else {
                document.body.classList.remove('customer-mode');
            }

            document.getElementById('welcomePage').classList.add('hidden');
            document.getElementById('appContainer').classList.add('active');
            renderInputTable('planned');
            
            // Render all charts immediately
            setTimeout(renderVisualizations, 200);
        }

        function goHome() {
            document.getElementById('appContainer').classList.remove('active');
            document.getElementById('welcomePage').classList.remove('hidden');
        }

        function downloadPDF(type) {
            let element;
            let filename;

            if (type === 'analysis') {
                element = document.getElementById('analysis-table-container');
                filename = 'Gustafs_Analys.pdf';
            } else if (type === 'visualization') {
                // Get the whole Dashboard container
                element = document.getElementById('viz-print-area');
                filename = 'Gustafs_Dashboard.pdf';
            }

            if(element) {
                const opt = {
                    margin:       10,
                    filename:     filename,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2 },
                    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'landscape' }
                };
                html2pdf().set(opt).from(element).save();
            }
        }

        function switchTab(tabId) {
            document.querySelectorAll('.sheet').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            const buttons = document.querySelectorAll('.nav-btn');
            if (tabId === 'planned') { buttons[0].classList.add('active'); renderInputTable('planned'); }
            if (tabId === 'actual') { buttons[1].classList.add('active'); renderInputTable('actual'); }
            if (tabId === 'variance') { buttons[2].classList.add('active'); renderVarianceTable(); }
            if (tabId === 'analysis') { buttons[3].classList.add('active'); renderAnalysisTable(); }
            if (tabId === 'visualization') { buttons[4].classList.add('active'); renderVisualizations(); }
        }

        function refreshActiveView() {
            const activeTab = document.querySelector('.sheet.active').id;
            if (activeTab === 'planned' || activeTab === 'actual') {
                renderInputTable(activeTab);
            } else if (activeTab === 'variance') {
                renderVarianceTable();
            } else if (activeTab === 'analysis') {
                renderAnalysisTable();
            } else if (activeTab === 'visualization') {
                renderVisualizations();
            }
        }

        // --- CORE FUNCTIONS FOR RENDERING TABLE WITH ADD BUTTONS ---

        function renderInputTable(type) {
            const container = document.getElementById(type + '-table-container');
            let html = '<table><thead><tr><th>Utgiftspost</th>';
            
            months.forEach(m => html += `<th>${m}</th>`);
            html += `<th>ÅR 
                        <button class="add-col-btn" onclick="addColumn()">+</button>
                        <button class="del-col-btn" onclick="removeColumn()">- tabort column</button>
                     </th></tr></thead><tbody>`;

            let rowCounter = 0;

            appData.forEach((cat, catIdx) => {
                html += `<tr class="category-header-row"><td colspan="${months.length + 2}">
                            ${cat.category}
                            <button class="add-btn" onclick="addItem(${catIdx})">+ Lägg till rad</button>
                         </td></tr>`;
                
                let catMonthlyTotals = new Array(months.length).fill(0);

                cat.items.forEach((item, itemIdx) => {
                    html += `<tr><td>
                                ${item.name} 
                                <button class="del-row-btn" onclick="removeItem(${catIdx}, ${itemIdx})">- tabort rad</button>
                             </td>`;
                    let itemTotal = 0;
                    item[type].forEach((val, monthIdx) => {
                        html += `<td><input type="number" 
                                     value="${val}" 
                                     data-cat="${cat.category}"
                                     data-item="${itemIdx}"
                                     data-month="${monthIdx}"
                                     data-type="${type}"
                                     data-r="${rowCounter}"
                                     data-c="${monthIdx}"
                                     class="excel-input" 
                                     onchange="updateData('${cat.category}', ${itemIdx}, '${type}', ${monthIdx}, this.value)">
                                 </td>`;
                        itemTotal += val;
                        catMonthlyTotals[monthIdx] += val;
                    });
                    html += `<td class="readonly-cell"><strong>${formatter.format(itemTotal)}</strong></td></tr>`;
                    rowCounter++;
                });

                html += `<tr class="subtotal-row"><td>Delsumma</td>`;
                catMonthlyTotals.forEach(val => html += `<td>${formatter.format(val)}</td>`);
                const catTotal = catMonthlyTotals.reduce((a, b) => a + b, 0);
                html += `<td>${formatter.format(catTotal)}</td></tr>`;
            });
            html += '</tbody></table>';

            html += `<div class="add-category-container">
                        <button class="add-cat-main-btn" onclick="addCategory()">+ Skapa ny kategori</button>
                     </div>`;

            container.innerHTML = html;

            attachDragEvents();
            attachKeyboardNav();
        }

        // --- MANIPULATION FUNCTIONS ---

        function addColumn() {
            const name = prompt("Namn på ny kolumn (t.ex. 'Jan 2026' eller 'Justering'):");
            if(!name) return;
            months.push(name); 
            appData.forEach(cat => {
                cat.items.forEach(item => {
                    item.planned.push(0);
                    item.actual.push(0);
                });
            });
            refreshActiveView();
        }

        function removeColumn() {
            if (months.length <= 1) {
                alert("Du måste ha minst en kolumn kvar.");
                return;
            }
            if(!confirm("Är du säker på att du vill ta bort den sista kolumnen?")) return;
            months.pop(); 
            appData.forEach(cat => {
                cat.items.forEach(item => {
                    item.planned.pop();
                    item.actual.pop();
                });
            });
            refreshActiveView();
        }

        function addItem(catIndex) {
            const name = prompt("Namn på ny utgiftspost:");
            if(!name) return;
            const len = months.length; 
            appData[catIndex].items.push({
                name: name,
                planned: new Array(len).fill(0),
                actual: new Array(len).fill(0)
            });
            refreshActiveView();
        }

        function removeItem(catIdx, itemIdx) {
            if(!confirm("Vill du ta bort denna rad?")) return;
            appData[catIdx].items.splice(itemIdx, 1);
            refreshActiveView();
        }

        function addCategory() {
            const name = prompt("Namn på ny kategori:");
            if(!name) return;
            appData.push({
                category: name,
                items: [] 
            });
            refreshActiveView();
        }

        function updateData(categoryName, itemIdx, type, monthIdx, newValue) {
            const cat = appData.find(c => c.category === categoryName);
            const item = cat.items[itemIdx];
            item[type][monthIdx] = parseFloat(newValue) || 0;
            if(!isDragging) renderInputTable(type);
        }

        function attachKeyboardNav() {
            const inputs = document.querySelectorAll('.excel-input');
            inputs.forEach(input => {
                input.addEventListener('keydown', (e) => {
                    const currentRow = parseInt(input.dataset.r);
                    const currentCol = parseInt(input.dataset.c);
                    let targetInput = null;

                    if (e.key === 'ArrowRight' || e.key === 'Tab') {
                        if(e.key === 'ArrowRight') e.preventDefault();
                        targetInput = document.querySelector(`.excel-input[data-r="${currentRow}"][data-c="${currentCol + 1}"]`);
                    } else if (e.key === 'ArrowLeft') {
                        e.preventDefault();
                        targetInput = document.querySelector(`.excel-input[data-r="${currentRow}"][data-c="${currentCol - 1}"]`);
                    } else if (e.key === 'ArrowDown' || e.key === 'Enter') {
                        e.preventDefault();
                        targetInput = document.querySelector(`.excel-input[data-r="${currentRow + 1}"][data-c="${currentCol}"]`);
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        targetInput = document.querySelector(`.excel-input[data-r="${currentRow - 1}"][data-c="${currentCol}"]`);
                    }

                    if (targetInput) {
                        targetInput.focus();
                        targetInput.select();
                    }
                });
            });
        }

        let dragHandle = document.getElementById('drag-handle');
        let currentFocusInput = null;
        let isDragging = false;
        let dragStartValue = 0;
        let dragTargets = new Set();
        let startX = 0;
        let startY = 0;

        function attachDragEvents() {
            const inputs = document.querySelectorAll('.excel-input');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    currentFocusInput = this;
                    positionHandle(this);
                });
            });
        }

        function positionHandle(input) {
            const rect = input.getBoundingClientRect();
            dragHandle.style.display = 'block';
            dragHandle.style.top = (rect.bottom + window.scrollY - 7) + 'px'; 
            dragHandle.style.left = (rect.right + window.scrollX - 7) + 'px';
        }

        window.addEventListener('scroll', () => { if (!isDragging) dragHandle.style.display = 'none'; }, true);

        dragHandle.addEventListener('mousedown', (e) => {
            if (!currentFocusInput) return;
            e.preventDefault();
            isDragging = true;
            dragStartValue = currentFocusInput.value;
            startX = e.clientX;
            startY = e.clientY;
            dragTargets.clear();
            document.body.style.cursor = 'crosshair';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;

            dragHandle.style.display = 'none';
            let elemBelow = document.elementFromPoint(e.clientX, e.clientY);
            dragHandle.style.display = 'block';

            if (!elemBelow) return;

            document.querySelectorAll('.drag-highlight').forEach(el => el.classList.remove('drag-highlight'));
            dragTargets.clear();

            const diffX = Math.abs(e.clientX - startX);
            const diffY = Math.abs(e.clientY - startY);
            
            const startRow = parseInt(currentFocusInput.dataset.r);
            const startCol = parseInt(currentFocusInput.dataset.c);

            if (elemBelow.tagName === 'INPUT' && elemBelow.classList.contains('excel-input')) {
                const targetRow = parseInt(elemBelow.dataset.r);
                const targetCol = parseInt(elemBelow.dataset.c);

                if (diffY > diffX) {
                    if (targetCol === startCol && targetRow > startRow) {
                        for (let r = startRow + 1; r <= targetRow; r++) {
                            const cell = document.querySelector(`.excel-input[data-r="${r}"][data-c="${startCol}"]`);
                            if (cell) {
                                cell.classList.add('drag-highlight');
                                dragTargets.add(cell);
                            }
                        }
                    }
                } else {
                    if (targetRow === startRow && targetCol > startCol) {
                        for (let c = startCol + 1; c <= targetCol; c++) {
                            const cell = document.querySelector(`.excel-input[data-r="${startRow}"][data-c="${c}"]`);
                            if (cell) {
                                cell.classList.add('drag-highlight');
                                dragTargets.add(cell);
                            }
                        }
                    }
                }
            }
        });

        document.addEventListener('mouseup', () => {
            if (!isDragging) return;
            isDragging = false;
            document.body.style.cursor = 'default';

            if (dragTargets.size > 0) {
                dragTargets.forEach(target => {
                    target.classList.remove('drag-highlight');
                    
                    const catName = target.dataset.cat;
                    const itemIdx = parseInt(target.dataset.item);
                    const type = target.dataset.type;
                    const monthIdx = parseInt(target.dataset.month);
                    
                    const cat = appData.find(c => c.category === catName);
                    if (cat) {
                        cat.items[itemIdx][type][monthIdx] = parseFloat(dragStartValue) || 0;
                    }
                });
                renderInputTable(currentFocusInput.dataset.type);
            }
        });

        function renderVarianceTable() {
            const container = document.getElementById('variance-table-container');
            let html = '<table><thead><tr><th>Utgiftspost</th>';
            months.forEach(m => html += `<th>${m}</th>`);
            html += '<th>ÅR</th></tr></thead><tbody>';

            appData.forEach(cat => {
                html += `<tr class="category-header-row"><td colspan="${months.length + 2}">${cat.category}</td></tr>`;
                
                let catMonthlyTotals = new Array(months.length).fill(0);

                cat.items.forEach(item => {
                    html += `<tr><td>${item.name}</td>`;
                    let itemTotal = 0;
                    for (let i = 0; i < months.length; i++) {
                        const variance = (item.planned[i] || 0) - (item.actual[i] || 0);
                        const cls = variance < 0 ? 'negative' : '';
                        html += `<td class="readonly-cell ${cls}">${formatter.format(variance)}</td>`;
                        itemTotal += variance;
                        catMonthlyTotals[i] += variance;
                    }
                    const rowCls = itemTotal < 0 ? 'negative' : '';
                    html += `<td class="readonly-cell ${rowCls}"><strong>${formatter.format(itemTotal)}</strong></td></tr>`;
                });

                html += `<tr class="subtotal-row"><td>Delsumma</td>`;
                catMonthlyTotals.forEach(val => {
                    const cls = val < 0 ? 'negative' : '';
                    html += `<td class="${cls}">${formatter.format(val)}</td>`;
                });
                const catTotal = catMonthlyTotals.reduce((a, b) => a + b, 0);
                const totalCls = catTotal < 0 ? 'negative' : '';
                html += `<td class="${totalCls}">${formatter.format(catTotal)}</td></tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderAnalysisTable() {
            const container = document.getElementById('analysis-table-container');
            let html = '<table><thead><tr><th>Utgiftskategori</th><th>Planerat</th><th>Faktiskt</th><th>Avvikelse</th><th>Avvikelse %</th></tr></thead><tbody>';
            
            let totalPlanned = 0;
            let totalActual = 0;

            appData.forEach(cat => {
                let catPlanned = 0;
                let catActual = 0;
                
                cat.items.forEach(item => {
                    catPlanned += item.planned.reduce((a, b) => a + b, 0);
                    catActual += item.actual.reduce((a, b) => a + b, 0);
                });

                const variance = catPlanned - catActual;
                const percent = catPlanned !== 0 ? (variance / catPlanned) * 100 : 0;
                const cls = variance < 0 ? 'negative' : '';

                html += `<tr>
                    <td>${cat.category}</td>
                    <td>${formatter.format(catPlanned)}</td>
                    <td>${formatter.format(catActual)}</td>
                    <td class="${cls}">${formatter.format(variance)}</td>
                    <td class="${cls}">${percent.toFixed(1)}%</td>
                </tr>`;

                totalPlanned += catPlanned;
                totalActual += catActual;
            });

            const totalVariance = totalPlanned - totalActual;
            const totalPercent = totalPlanned !== 0 ? (totalVariance / totalPlanned) * 100 : 0;
            const totalCls = totalVariance < 0 ? 'negative' : '';

            html += `<tr class="subtotal-row">
                <td>TOTALT</td>
                <td>${formatter.format(totalPlanned)}</td>
                <td>${formatter.format(totalActual)}</td>
                <td class="${totalCls}">${formatter.format(totalVariance)}</td>
                <td class="${totalCls}">${totalPercent.toFixed(1)}%</td>
            </tr>`;
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderVisualizations() {
            renderCategoryChart();
            renderTrendChart();
            renderComparisonChart();
        }

        // --- CHART.JS IMPLEMENTATIONS ---

        function getThemeColors() {
            const isCustomer = document.body.classList.contains('customer-mode');
            if (isCustomer) {
                return {
                    primary: '#00838f',
                    secondary: '#26c6da',
                    background: '#e0f7fa',
                    text: '#006064',
                    palette: ['#006064', '#00838f', '#0097a7', '#00acc1', '#26c6da', '#4dd0e1', '#80deea']
                };
            } else {
                return {
                    primary: '#8b6f47',
                    secondary: '#a0825a',
                    background: '#f5f0e8',
                    text: '#6b5436',
                    palette: ['#6b5436', '#8b6f47', '#a0825a', '#b5956d', '#c9a880', '#dcc8a8', '#f0ebe3']
                };
            }
        }

        function renderCategoryChart() {
            const ctx = document.getElementById('categoryChartCanvas').getContext('2d');
            const theme = getThemeColors();

            const labels = [];
            const data = [];
            appData.forEach(cat => {
                let total = 0;
                cat.items.forEach(item => {
                    total += item.actual.reduce((a, b) => a + b, 0);
                });
                labels.push(cat.category);
                data.push(total);
            });

            if (chartInstances.category) {
                chartInstances.category.destroy();
            }

            chartInstances.category = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: theme.palette,
                        borderColor: '#ffffff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#555', font: { family: 'Helvetica Neue' } } },
                        title: { display: false }
                    }
                }
            });
        }

        function renderTrendChart() {
            const ctx = document.getElementById('trendChartCanvas').getContext('2d');
            const theme = getThemeColors();
            const len = months.length;

            const monthlyPlanned = new Array(len).fill(0);
            const monthlyActual = new Array(len).fill(0);

            appData.forEach(cat => {
                cat.items.forEach(item => {
                    for (let i = 0; i < len; i++) {
                        monthlyPlanned[i] += item.planned[i] || 0;
                        monthlyActual[i] += item.actual[i] || 0;
                    }
                });
            });

            if (chartInstances.trend) {
                chartInstances.trend.destroy();
            }

            chartInstances.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Planerat',
                            data: monthlyPlanned,
                            borderColor: theme.primary,
                            backgroundColor: theme.primary,
                            borderWidth: 3,
                            pointRadius: 4,
                            tension: 0.3,
                            fill: false
                        },
                        {
                            label: 'Faktiskt',
                            data: monthlyActual,
                            borderColor: '#c85450',
                            backgroundColor: '#c85450',
                            borderWidth: 3,
                            pointRadius: 4,
                            tension: 0.3,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#e0e0e0' },
                            ticks: { color: '#666' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#666' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#555' } },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    }
                }
            });
        }

        function renderComparisonChart() {
            const ctx = document.getElementById('comparisonChartCanvas').getContext('2d');
            const theme = getThemeColors();

            const labels = [];
            const plannedData = [];
            const actualData = [];

            appData.forEach(cat => {
                let planned = 0;
                let actual = 0;
                cat.items.forEach(item => {
                    planned += item.planned.reduce((a, b) => a + b, 0);
                    actual += item.actual.reduce((a, b) => a + b, 0);
                });
                labels.push(cat.category);
                plannedData.push(planned);
                actualData.push(actual);
            });

            if (chartInstances.comparison) {
                chartInstances.comparison.destroy();
            }

            chartInstances.comparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Planerat',
                            data: plannedData,
                            backgroundColor: theme.primary,
                            borderRadius: 4
                        },
                        {
                            label: 'Faktiskt',
                            data: actualData,
                            backgroundColor: '#c85450',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#e0e0e0' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });
        }
    </script>
</body>
</html>